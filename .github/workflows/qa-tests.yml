name: Geotravel QA Automation

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

jobs:
  run-smoke-tests:
    name: ğŸš€ Run Smoke Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for git operations

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: âš™ï¸ Load environment variables
        run: |
          echo "TEST_ENV=${{ secrets.TEST_ENV }}" >> $GITHUB_ENV
          echo "BROWSER=${{ secrets.BROWSER }}" >> $GITHUB_ENV
          echo "HEADLESS=${{ secrets.HEADLESS }}" >> $GITHUB_ENV
          echo "TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL }}" >> $GITHUB_ENV
          echo "TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }}" >> $GITHUB_ENV
          echo "API_TEST_EMAIL=${{ secrets.API_TEST_EMAIL }}" >> $GITHUB_ENV
          echo "API_TEST_PASSWORD=${{ secrets.API_TEST_PASSWORD }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ secrets.PROJECT_NAME }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ secrets.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "PARTNERS_VERIFIED_EMAIL=${{ secrets.PARTNERS_VERIFIED_EMAIL }}" >> $GITHUB_ENV
          echo "PARTNERS_VERIFIED_PASSWORD=${{ secrets.PARTNERS_VERIFIED_PASSWORD }}" >> $GITHUB_ENV

      # Create docs/ structure if it doesn't exist
      - name: ğŸ—ï¸ Setup docs directory
        run: |
          mkdir -p docs/screenshots/failures
          if [ ! -f docs/index.html ]; then
            echo "Creating minimal index.html..."
            echo '<!DOCTYPE html><html><head><title>GeoTravel Dashboard</title></head><body><h1>GeoTravel Test Dashboard</h1><p>Screenshots will appear here.</p></body></html>' > docs/index.html
          fi

      - name: ğŸ§ª Run smoke test suite
        run: |
          echo "Running smoke tests on $TEST_ENV..."
          python scripts/run_scheduled_tests.py --suite api smoke partners_api
        continue-on-error: true

      # NEW: Commit screenshots to docs/ folder
      - name: ğŸ“ Commit Screenshots to Repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Contents of docs/screenshots/failures/:"
          ls -la docs/screenshots/failures/ || echo "Directory doesn't exist"
          
          # Setup git with token
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Set remote URL with token
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || git reset --hard origin/main

          # Ensure directory exists
          mkdir -p docs/screenshots/failures

          # Force add (ignore .gitignore)
          git add -f docs/screenshots/failures/

          # Show what will be committed
          echo "ğŸ“‹ Git status:"
          git status --porcelain

          # Commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ“¸ Add test failure screenshots [skip ci]"
            git pull --rebase origin main
            git push
            echo "âœ… Screenshots committed to repository"
          else
            echo "âŒ No changes to commit (screenshots may be gitignored)"
            # List ignored files
            git check-ignore docs/screenshots/failures/* || true
          fi

      # Upload artifacts for debugging
      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test_results
          path: |
            reports/
            logs/
          retention-days: 7

      - name: ğŸ§¹ Cleanup old reports
        run: python scripts/cleanup.py --days 7

  publish-reports:
    name: ğŸ“Š Publish Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: run-smoke-tests
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test_results
          path: ./

      - name: âœ… Ensure reports folder exists
        run: |
          if [ ! -d "reports" ]; then
            echo "âš ï¸ No reports directory found. Creating empty directory for GitHub Pages.";
            mkdir -p reports
            echo '<!DOCTYPE html><html><head><title>Test Reports</title></head><body><h1>No test reports available</h1><p>No test reports were generated in this run.</p></body></html>' > reports/index.html
          fi

      - name: ğŸš€ Deploy reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
          allow_empty_commit: true
          force_orphan: true  # Keeps history clean
          keep_files: false   # Remove old files

      - name: ğŸ”— Show published URL
        run: |
          echo "ğŸ“Š Reports published to GitHub Pages"
          echo "ğŸŒ Default URL:"
          echo "https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/"
          echo ""
          echo "ğŸ“ If reports are in a subdirectory:"
          echo "https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/reports/"