name: Geotravel QA Automation

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

jobs:
  run-tests:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # --- Setup ---
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ‚öôÔ∏è Load environment variables
        run: |
          echo "TEST_ENV=${{ secrets.TEST_ENV }}" >> $GITHUB_ENV
          echo "BROWSER=${{ secrets.BROWSER }}" >> $GITHUB_ENV
          echo "HEADLESS=${{ secrets.HEADLESS }}" >> $GITHUB_ENV
          echo "TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL }}" >> $GITHUB_ENV
          echo "TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }}" >> $GITHUB_ENV
          echo "API_TEST_EMAIL=${{ secrets.API_TEST_EMAIL }}" >> $GITHUB_ENV
          echo "API_TEST_PASSWORD=${{ secrets.API_TEST_PASSWORD }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ secrets.PROJECT_NAME }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ secrets.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "PARTNERS_VERIFIED_EMAIL=${{ secrets.PARTNERS_VERIFIED_EMAIL }}" >> $GITHUB_ENV
          echo "PARTNERS_VERIFIED_PASSWORD=${{ secrets.PARTNERS_VERIFIED_PASSWORD }}" >> $GITHUB_ENV
      
      - name: üè∑Ô∏è Set timestamp for reporting
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "GH_PAGES_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "FOLDER_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      # --- Run Tests ---
      - name: üß™ Run test suites
        run: |
          echo "Running test suites with timestamp: $RUN_TIMESTAMP..."
          python scripts/run_scheduled_tests.py --suite smoke api partners_api
        continue-on-error: true

      # --- Prepare Files for GitHub Pages ---
      - name: üìÅ Prepare files for GitHub Pages
        run: |
          # Create timestamp
          TIMESTAMP="$RUN_TIMESTAMP"
          
          # Clean and create folder
          rm -rf gh-pages-content || true
          mkdir -p gh-pages-content
          
          # Create run folder
          RUN_DIR="gh-pages-content/$TIMESTAMP"
          mkdir -p "$RUN_DIR"
          
          # Copy files
          mkdir -p "$RUN_DIR/screenshots"
          mkdir -p "$RUN_DIR/logs"
          mkdir -p "$RUN_DIR/api_failed_responses"
          mkdir -p "$RUN_DIR/reports"
          
          # Copy screenshots
          if [ -d "docs/screenshots/failures" ]; then
            cp docs/screenshots/failures/* "$RUN_DIR/screenshots/" 2>/dev/null || true
          fi
          
          # Copy API responses
          if [ -d "reports/failed_responses" ]; then
            cp reports/failed_responses/* "$RUN_DIR/api_failed_responses/" 2>/dev/null || true
          fi
          
          # Copy logs
          if [ -d "logs" ]; then
            cp logs/* "$RUN_DIR/logs/" 2>/dev/null || true
          fi
          
          # Copy reports
          if [ -d "reports" ]; then
            cp reports/*.html reports/*.json "$RUN_DIR/reports/" 2>/dev/null || true
          fi
          
          # Create simple index for this run
          echo "<!DOCTYPE html>" > "$RUN_DIR/index.html"
          echo "<html><head><title>Test Results - $TIMESTAMP</title>" >> "$RUN_DIR/index.html"
          echo "<style>body{font-family:Arial;margin:20px;} h1{color:#2e61e6;} ul{list-style:none;padding:0;} li{margin:5px 0;} a{color:#2e61e6;}</style>" >> "$RUN_DIR/index.html"
          echo "</head><body>" >> "$RUN_DIR/index.html"
          echo "<h1>Test Results - $TIMESTAMP</h1>" >> "$RUN_DIR/index.html"
          
          # Add screenshots list
          echo "<h2>Screenshots</h2><ul>" >> "$RUN_DIR/index.html"
          for file in "$RUN_DIR/screenshots"/*; do
            [ -f "$file" ] && filename=$(basename "$file") && echo "<li><a href='screenshots/$filename'>$filename</a></li>" >> "$RUN_DIR/index.html"
          done
          echo "</ul>" >> "$RUN_DIR/index.html"
          
          # Add logs list
          echo "<h2>Logs</h2><ul>" >> "$RUN_DIR/index.html"
          for file in "$RUN_DIR/logs"/*; do
            [ -f "$file" ] && filename=$(basename "$file") && echo "<li><a href='logs/$filename'>$filename</a></li>" >> "$RUN_DIR/index.html"
          done
          echo "</ul>" >> "$RUN_DIR/index.html"
          
          # Add API responses list
          echo "<h2>API Responses</h2><ul>" >> "$RUN_DIR/index.html"
          for file in "$RUN_DIR/api_failed_responses"/*; do
            [ -f "$file" ] && filename=$(basename "$file") && echo "<li><a href='api_failed_responses/$filename'>$filename</a></li>" >> "$RUN_DIR/index.html"
          done
          echo "</ul>" >> "$RUN_DIR/index.html"
          
          # Add reports list
          echo "<h2>Reports</h2><ul>" >> "$RUN_DIR/index.html"
          for file in "$RUN_DIR/reports"/*; do
            [ -f "$file" ] && filename=$(basename "$file") && echo "<li><a href='reports/$filename'>$filename</a></li>" >> "$RUN_DIR/index.html"
          done
          echo "</ul>" >> "$RUN_DIR/index.html"
          
          echo "<p>Made with ‚ù§Ô∏è by Only1JohnN</p></body></html>" >> "$RUN_DIR/index.html"

      # --- Create Main Index ---
      - name: üè† Create main index
        run: |
          TIMESTAMP="$RUN_TIMESTAMP"
          
          echo "<!DOCTYPE html>" > gh-pages-content/index.html
          echo "<html><head><title>GeoTravel Tests</title>" >> gh-pages-content/index.html
          echo "<style>body{font-family:Arial;margin:0;padding:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;}" >> gh-pages-content/index.html
          echo ".container{max-width:800px;margin:0 auto;padding:40px 20px;}" >> gh-pages-content/index.html
          echo ".card{background:white;border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center;}" >> gh-pages-content/index.html
          echo "h1{color:#2e61e6;margin-bottom:10px;}" >> gh-pages-content/index.html
          echo ".btn{display:inline-block;padding:12px 24px;background:#2e61e6;color:white;text-decoration:none;border-radius:8px;margin:10px;}" >> gh-pages-content/index.html
          echo ".btn:hover{background:#1a4dc7;}" >> gh-pages-content/index.html
          echo ".footer{margin-top:40px;color:#666;}" >> gh-pages-content/index.html
          echo "</style></head><body>" >> gh-pages-content/index.html
          echo "<div class='container'><div class='card'>" >> gh-pages-content/index.html
          echo "<h1>üöÄ GeoTravel Test Results</h1>" >> gh-pages-content/index.html
          echo "<p>All test artifacts in one place</p>" >> gh-pages-content/index.html
          echo "<div style='background:#f8f9fa;padding:25px;border-radius:10px;margin:30px 0;border-left:4px solid #2e61e6;'>" >> gh-pages-content/index.html
          echo "<h3>Latest Run: $TIMESTAMP</h3>" >> gh-pages-content/index.html
          echo "<a href='$TIMESTAMP/' class='btn'>üìÇ View Latest Results</a>" >> gh-pages-content/index.html
          echo "</div>" >> gh-pages-content/index.html
          echo "<div class='footer'>" >> gh-pages-content/index.html
          echo "<p>Made with ‚ù§Ô∏è by Only1JohnN</p>" >> gh-pages-content/index.html
          echo "<p>Simple file access</p>" >> gh-pages-content/index.html
          echo "</div></div></div></body></html>" >> gh-pages-content/index.html

      # --- Deploy to GitHub Pages ---
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          allow_empty_commit: true
          force_orphan: false
          keep_files: true

      # --- Show URL ---
      - name: üîó Show published URL
        run: |
          echo ""
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo ""
          echo "üåê View at: https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/"
          echo ""
          echo "üìÅ Latest run: $RUN_TIMESTAMP"