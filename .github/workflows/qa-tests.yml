name: Geotravel QA Automation

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

jobs:
  run-tests:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # --- Setup ---
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ‚öôÔ∏è Load environment variables
        run: |
          echo "TEST_ENV=${{ secrets.TEST_ENV }}" >> $GITHUB_ENV
          echo "BROWSER=${{ secrets.BROWSER }}" >> $GITHUB_ENV
          echo "HEADLESS=${{ secrets.HEADLESS }}" >> $GITHUB_ENV
          echo "TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL }}" >> $GITHUB_ENV
          echo "TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }}" >> $GITHUB_ENV
          echo "API_TEST_EMAIL=${{ secrets.API_TEST_EMAIL }}" >> $GITHUB_ENV
          echo "API_TEST_PASSWORD=${{ secrets.API_TEST_PASSWORD }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ secrets.PROJECT_NAME }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ secrets.ENVIRONMENT }}" >> $GITHUB_ENV
          echo "PARTNERS_VERIFIED_EMAIL=${{ secrets.PARTNERS_VERIFIED_EMAIL }}" >> $GITHUB_ENV
          echo "PARTNERS_VERIFIED_PASSWORD=${{ secrets.PARTNERS_VERIFIED_PASSWORD }}" >> $GITHUB_ENV

      # --- Run Tests ---
      - name: üß™ Run test suites
        run: |
          echo "Running test suites..."
          python scripts/run_scheduled_tests.py --suite smoke api partners_api
        continue-on-error: true

      # --- Prepare Files for GitHub Pages ---
      - name: üìÅ Prepare files for GitHub Pages
        run: |
          # Create timestamp
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          # Create gh-pages folder
          rm -rf gh-pages-content || true
          mkdir -p gh-pages-content
          
          # Create run folder
          RUN_DIR="gh-pages-content/$TIMESTAMP"
          mkdir -p "$RUN_DIR"
          
          # Copy screenshots
          echo "üì∏ Copying screenshots..."
          if [ -d "docs/screenshots/failures" ]; then
            mkdir -p "$RUN_DIR/screenshots"
            cp docs/screenshots/failures/* "$RUN_DIR/screenshots/" 2>/dev/null || true
          fi
          
          # Copy API failed responses
          echo "üì¶ Copying API failed responses..."
          if [ -d "reports/failed_responses" ]; then
            mkdir -p "$RUN_DIR/api_failed_responses"
            cp reports/failed_responses/* "$RUN_DIR/api_failed_responses/" 2>/dev/null || true
          fi
          
          # Copy logs
          echo "üìÑ Copying logs..."
          if [ -d "logs" ]; then
            mkdir -p "$RUN_DIR/logs"
            cp logs/* "$RUN_DIR/logs/" 2>/dev/null || true
          fi
          
          # Copy test reports
          echo "üìä Copying test reports..."
          if [ -d "reports" ]; then
            mkdir -p "$RUN_DIR/reports"
            cp reports/*.html reports/*.json "$RUN_DIR/reports/" 2>/dev/null || true
          fi

      # --- Create Static HTML Wrappers for Text Files ---
      - name: üé® Create static text file viewers
        run: |
          TIMESTAMP="$RUN_TIMESTAMP"
          
          # Function to create HTML wrapper for a text file
          create_text_wrapper() {
            local file_path="$1"
            local file_name="$(basename "$file_path")"
            local file_ext="${file_name##*.}"
            local html_file="${file_path%.*}.html"
            
            # Get file content
            if [ -f "$file_path" ]; then
              # Escape HTML special characters
              content=$(cat "$file_path" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&apos;/g')
              
              # Create HTML file
              cat > "$html_file" << EOF
              <!DOCTYPE html>
              <html>
              <head>
                  <title>$file_name - GeoTravel</title>
                  <style>
                      :root { --primary: #2e61e6; }
                      body { 
                          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                          margin: 0; padding: 20px; background: #f5f7fa; color: #333;
                      }
                      .container { 
                          max-width: 1200px; margin: 20px auto; background: white; 
                          border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
                          overflow: hidden;
                      }
                      .header { 
                          background: linear-gradient(90deg, var(--primary) 0%, #5a8aff 100%); 
                          color: white; padding: 20px; display: flex; justify-content: space-between;
                          align-items: center;
                      }
                      .header h1 { margin: 0; font-size: 1.5em; }
                      .content { padding: 20px; }
                      pre { 
                          background: #f8f9fa; padding: 20px; border-radius: 5px; 
                          overflow-x: auto; border-left: 4px solid var(--primary);
                          max-height: 70vh; overflow-y: auto;
                          white-space: pre-wrap; /* Wrap long lines */
                          word-wrap: break-word;
                      }
                      .actions { margin-top: 20px; text-align: right; }
                      .btn { 
                          display: inline-block; padding: 8px 16px; background: var(--primary); 
                          color: white; text-decoration: none; border-radius: 4px; margin-left: 10px;
                      }
                      .btn:hover { background: #1a4dc7; }
                      .footer { 
                          margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; 
                          text-align: center; color: #666; font-size: 0.9em;
                      }
                      .heart { color: #e74c3c; }
                      .file-info { background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
                  </style>
              </head>
              <body>
                  <div class="container">
                      <div class="header">
                          <h1>$file_name</h1>
                          <div>
                              <a href="$file_name" download class="btn">üì• Download</a>
                              <a href="javascript:history.back()" class="btn">‚Üê Back</a>
                          </div>
                      </div>
                      <div class="content">
                          <div class="file-info">
                              üìÅ File: $file_name | üìä Size: $(du -h "$file_path" | cut -f1) | üìù Type: $file_ext
                          </div>
                          <pre id="content">$content</pre>
                      </div>
                      <div class="footer">
                          <p><i class="fas fa-code"></i> with <i class="fas fa-heart heart"></i> from <strong>Only1JohnN</strong></p>
                      </div>
                  </div>
                  
                  <script>
                      // Simple syntax highlighting for JSON
                      document.addEventListener('DOMContentLoaded', function() {
                          const pre = document.getElementById('content');
                          const text = pre.textContent;
                          
                          if ('$file_ext' === 'json') {
                              try {
                                  const json = JSON.parse(text);
                                  pre.textContent = JSON.stringify(json, null, 2);
                              } catch(e) {
                                  // Not valid JSON
                              }
                          }
                          
                          // Add line numbers
                          const lines = pre.textContent.split('\\n');
                          if (lines.length > 1) {
                              let numbered = '';
                              for (let i = 0; i < lines.length; i++) {
                                  numbered += \`<span style="color:#666; margin-right:15px;">\${i+1}</span>\${lines[i]}\\n\`;
                              }
                              pre.innerHTML = numbered;
                          }
                      });
                  </script>
              </body>
              </html>
              EOF
              
              echo "Created HTML wrapper: $html_file"
            fi
          }
          
          # Process all text files
          echo "Creating HTML wrappers for text files..."
          
          # Process logs
          if [ -d "gh-pages-content/$TIMESTAMP/logs" ]; then
            for file in gh-pages-content/$TIMESTAMP/logs/*.log gh-pages-content/$TIMESTAMP/logs/*.txt; do
              [ -f "$file" ] && create_text_wrapper "$file"
            done
          fi
          
          # Process API responses
          if [ -d "gh-pages-content/$TIMESTAMP/api_failed_responses" ]; then
            for file in gh-pages-content/$TIMESTAMP/api_failed_responses/*.json gh-pages-content/$TIMESTAMP/api_failed_responses/*.txt; do
              [ -f "$file" ] && create_text_wrapper "$file"
            done
          fi
          
          # Update the index.html to link to .html files instead of raw .txt/.log
          cat > "gh-pages-content/$TIMESTAMP/index.html" << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Run $TIMESTAMP</title>
              <style>
                  body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
                  .container { max-width: 1000px; margin: 0 auto; }
                  .header { text-align: center; margin-bottom: 30px; }
                  h1 { color: #2e61e6; }
                  .section { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
                  .section h2 { color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
                  .file-list { list-style: none; padding: 0; }
                  .file-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
                  .file-item:hover { background: #f8f9fa; }
                  .file-icon { margin-right: 10px; font-size: 1.2em; }
                  .file-name { flex: 1; }
                  .file-size { color: #6c757d; font-size: 0.9em; }
                  .text-file { color: #2e61e6; text-decoration: none; }
                  .text-file:hover { text-decoration: underline; }
                  .back-btn { display: inline-block; padding: 8px 16px; background: #6c757d; color: white; 
                            text-decoration: none; border-radius: 4px; margin-top: 20px; }
                  .back-btn:hover { background: #545b62; }
                  .file-actions { margin-left: 10px; }
                  .file-actions a { color: #6c757d; text-decoration: none; margin-left: 10px; font-size: 0.9em; }
                  .file-actions a:hover { color: #2e61e6; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>Test Run: $TIMESTAMP</h1>
                      <p>Click üìÑ icons to view files with UI wrapper</p>
                  </div>
                  
                  <!-- Screenshots Section -->
                  <div class="section">
                      <h2>üñºÔ∏è Screenshots</h2>
                      <ul class="file-list" id="screenshots-list">
                          <li>Loading...</li>
                      </ul>
                  </div>
                  
                  <!-- Logs Section -->
                  <div class="section">
                      <h2>üìÑ Logs</h2>
                      <ul class="file-list" id="logs-list">
                          <li>Loading...</li>
                      </ul>
                  </div>
                  
                  <!-- API Failed Responses Section -->
                  <div class="section">
                      <h2>üìä API Failed Responses</h2>
                      <ul class="file-list" id="api-list">
                          <li>Loading...</li>
                      </ul>
                  </div>
                  
                  <!-- Reports Section -->
                  <div class="section">
                      <h2>üìã Test Reports</h2>
                      <ul class="file-list" id="reports-list">
                          <li>Loading...</li>
                      </ul>
                  </div>
                  
                  <a href="../" class="back-btn">‚Üê Back to All Runs</a>
              </div>
              
              <script>
                  // Helper to list files
                  function listFiles(elementId, folderPath, isTextFolder = false) {
                      const list = document.getElementById(elementId);
                      list.innerHTML = '<li>Loading files...</li>';
                      
                      // Use static listing since we can't fetch directory
                      setTimeout(() => {
                          list.innerHTML = '<li>Files are available in the directory</li>' +
                                          '<li>Navigate to the folder above to see files</li>';
                      }, 1000);
                  }
                  
                  // Load all sections
                  document.addEventListener('DOMContentLoaded', () => {
                      listFiles('screenshots-list', 'screenshots');
                      listFiles('logs-list', 'logs', true);
                      listFiles('api-list', 'api_failed_responses', true);
                      listFiles('reports-list', 'reports');
                  });
              </script>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Static HTML wrappers created"

      # --- Deploy to GitHub Pages ---
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          allow_empty_commit: true
          force_orphan: false
          keep_files: true

      # --- Show URL ---
      - name: üîó Show published URL
        run: |
          echo ""
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo ""
          echo "üåê View at: https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/"
          echo ""
          echo "üìÅ Direct file access:"
          echo "   ‚Ä¢ Screenshots: https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/$RUN_TIMESTAMP/screenshots/"
          echo "   ‚Ä¢ Logs: https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/$RUN_TIMESTAMP/logs/"
          echo "   ‚Ä¢ API Responses: https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/$RUN_TIMESTAMP/api_failed_responses/"
          echo ""
          echo "üí° .txt/.log files will open in the UI viewer"